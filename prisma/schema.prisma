// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String              @id @default(cuid())
  email           String              @unique
  passwordHash    String?
  createdAt       DateTime            @default(now())
  monsters        UserMonster[]
  packOpens       PackOpen[]
  squads          Squad[]
  gameweekEntries GameweekEntry[]
  gameweekScores  UserGameweekScore[]
}

model UserMonster {
  id                 String          @id @default(cuid())
  user               User            @relation(fields: [userId], references: [id])
  userId             String
  templateCode       String
  displayName        String
  realPlayerName     String
  position           String          // "GK", "DEF", "MID", "FWD"
  club               String
  rarity             String
  baseAttack         Int
  baseMagic          Int
  baseDefense        Int
  createdAt          DateTime        @default(now())

  // Evolution + cumulative stats
  evolutionLevel     Int             @default(0)
  totalGoals         Int             @default(0)
  totalAssists       Int             @default(0)
  totalCleanSheets   Int             @default(0)
  totalFantasyPoints Int             @default(0)

  squadSlots         SquadMonster[]
  gameweekSlots      GameweekEntryMonster[]
  evolutionEvents    EvolutionEvent[]
}

model PackOpen {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  packType  String
  createdAt DateTime @default(now())
}

// Saved “default” squad (your general 6-monster matchday squad)
model Squad {
  id        String         @id @default(cuid())
  user      User           @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  slots     SquadMonster[]
}

model SquadMonster {
  id            String      @id @default(cuid())
  squad         Squad       @relation(fields: [squadId], references: [id])
  squadId       String
  userMonster   UserMonster @relation(fields: [userMonsterId], references: [id])
  userMonsterId String
  slot          Int
}

// Gameweek definitions
model Gameweek {
  id              String             @id @default(cuid())
  number          Int
  name            String?
  deadlineAt      DateTime
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  entries         GameweekEntry[]
  scores          UserGameweekScore[]
  evolutionEvents EvolutionEvent[]
}

// A locked entry of your 6-monster squad for a given gameweek
model GameweekEntry {
  id         String                  @id @default(cuid())
  user       User                    @relation(fields: [userId], references: [id])
  userId     String
  gameweek   Gameweek                @relation(fields: [gameweekId], references: [id])
  gameweekId String
  createdAt  DateTime                @default(now())
  monsters   GameweekEntryMonster[]
}

// Each monster in a gameweek entry (6 of them, 2 treated as subs)
model GameweekEntryMonster {
  id            String        @id @default(cuid())
  entry         GameweekEntry @relation(fields: [entryId], references: [id])
  entryId       String
  userMonster   UserMonster   @relation(fields: [userMonsterId], references: [id])
  userMonsterId String
  slot          Int
  isSub         Boolean       @default(false)
}

// Total points for a user in a given gameweek (for leaderboards)
model UserGameweekScore {
  id         String    @id @default(cuid())
  user       User      @relation(fields: [userId], references: [id])
  userId     String
  gameweek   Gameweek  @relation(fields: [gameweekId], references: [id])
  gameweekId String
  points     Int       @default(0)
  createdAt  DateTime  @default(now())

  @@unique([userId, gameweekId])
}

// Evolution log (for future UI + history)
model EvolutionEvent {
  id            String       @id @default(cuid())
  userMonster   UserMonster  @relation(fields: [userMonsterId], references: [id])
  userMonsterId String
  gameweek      Gameweek?    @relation(fields: [gameweekId], references: [id])
  gameweekId    String?
  reason        String
  oldLevel      Int
  newLevel      Int
  createdAt     DateTime     @default(now())
}
