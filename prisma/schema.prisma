// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Editions for user-owned monsters.
// BASE = normal card, THEMED = Christmas Terrors etc, LIMITED = 1/100, 1/10, etc.
enum EditionType {
  BASE
  THEMED
  LIMITED
}

model User {
  id                 String               @id @default(cuid())
  email              String               @unique
  passwordHash       String?
  createdAt          DateTime             @default(now())
  coins              Int                  @default(1000)
  username           String?              @unique

  monsters           UserMonster[]
  packOpens          PackOpen[]
  squads             Squad[]
  gameweekEntries    GameweekEntry[]
  gameweekScores     UserGameweekScore[]
  leaguesOwned       League[]             @relation("LeagueOwner")
  leagueMemberships  LeagueMember[]

  listings           MarketListing[]
  transactionsBought MarketTransaction[]  @relation("Buyer")
  transactionsSold   MarketTransaction[]  @relation("Seller")

  // NEW: squad builder challenges (SBCs)
  squadChallengeSubmissions SquadChallengeSubmission[]

  // NEW: objectives progress
  objectiveProgresses       ObjectiveProgress[]

  // NEW: objective set progress (paths)
  objectiveSetProgresses    UserObjectiveSetProgress[]

  // NEW: daily streak (one row per user)
  dailyStreak               DailyStreak?

  // NEW: acts as "actor" in monster history (who found/evolved/sold/etc)
  monsterHistoryEvents      MonsterHistoryEvent[] @relation("MonsterHistoryActor")

  // NEW: reward packs earned from objectives / paths / SBCs
  rewardPacks               RewardPack[]

  // NEW: chips owned by the user (for evolution tasks)
  chips                     UserChip[]

  // NEW: PvP battle relations
  battleMatchesAsPlayer1    BattleMatch[]         @relation("BattleMatchPlayer1")
  battleMatchesAsPlayer2    BattleMatch[]         @relation("BattleMatchPlayer2")
  battleQueueEntry          BattleQueueEntry?
}

model UserMonster {
  id                 String               @id @default(cuid())
  user               User                 @relation(fields: [userId], references: [id])
  userId             String
  templateCode       String
  displayName        String
  realPlayerName     String
  position           String               // "GK", "DEF", "MID", "FWD"
  club               String
  rarity             String
  baseAttack         Int
  baseMagic          Int
  baseDefense        Int

  // Theming / sets & editions (Christmas Terrors, Halloween, limited 1/100 etc)
  setCode            String?              // e.g. "BASE", "CHRISTMAS_TERRORS_2025"
  editionType        EditionType          @default(BASE)
  serialNumber       Int?                 // e.g. 1–100
  editionLabel       String?              // e.g. "1 of 100", "Founders Edition"
  artBasePath        String?              // e.g. "/cards/base/ARS_1234.png"
  artHoverPath       String?              // e.g. "/cards/base/ARS_1234_hover.webm"
  traitsJson         Json?                // archetype metadata (element, bodyType, etc.)

  createdAt          DateTime             @default(now())

  // Evolution + cumulative stats
  evolutionLevel     Int                  @default(0)
  totalGoals         Int                  @default(0)
  totalAssists       Int                  @default(0)
  totalCleanSheets   Int                  @default(0)
  totalFantasyPoints Int                  @default(0)

  // NEW: how many blanks in a row (base points <= 2) this monster has had
  blankStreak        Int                  @default(0)

  // NEW: consumed by SBC / other sinks, removed from active collection
  isConsumed         Boolean              @default(false)

  squadSlots         SquadMonster[]
  gameweekSlots      GameweekEntryMonster[]
  evolutionEvents    EvolutionEvent[]

  // CHANGED: one monster can have many listings over time
  marketListings     MarketListing[]      @relation("UserMonsterListings")
  transactions       MarketTransaction[]

  // NEW: used in SBC submissions
  squadChallengeSlots SquadChallengeSubmissionMonster[]

  // NEW: history of this monster (who found/evolved/sold/etc)
  historyEvents      MonsterHistoryEvent[]

  // NEW: chip assignments for specific gameweeks
  chipAssignments    MonsterChipAssignment[]
}

model PackOpen {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  packType  String
  createdAt DateTime @default(now())
}

// Saved “default” squad (your general 6-monster matchday squad)
model Squad {
  id        String         @id @default(cuid())
  user      User           @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  slots     SquadMonster[]
}

model SquadMonster {
  id            String      @id @default(cuid())
  squad         Squad       @relation(fields: [squadId], references: [id])
  squadId       String
  userMonster   UserMonster @relation(fields: [userMonsterId], references: [id])
  userMonsterId String
  slot          Int
}

// Gameweek definitions
model Gameweek {
  id              String             @id @default(cuid())
  number          Int
  name            String?
  deadlineAt      DateTime
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  entries         GameweekEntry[]
  scores          UserGameweekScore[]
  evolutionEvents EvolutionEvent[]

  // NEW: chip assignments targeting this gameweek
  chipAssignments MonsterChipAssignment[]
}

// A locked entry of your 6-monster squad for a given gameweek
model GameweekEntry {
  id         String                  @id @default(cuid())
  user       User                    @relation(fields: [userId], references: [id])
  userId     String
  gameweek   Gameweek                @relation(fields: [gameweekId], references: [id])
  gameweekId String
  createdAt  DateTime                @default(now())
  monsters   GameweekEntryMonster[]
}

// Each monster in a gameweek entry (6 of them, 2 treated as subs)
model GameweekEntryMonster {
  id            String        @id @default(cuid())
  entry         GameweekEntry @relation(fields: [entryId], references: [id])
  entryId       String
  userMonster   UserMonster   @relation(fields: [userMonsterId], references: [id])
  userMonsterId String
  slot          Int
  isSub         Boolean       @default(false)

  // points scored by this monster in this specific gameweek (after multipliers)
  points        Int           @default(0)
}

// Total points for a user in a given gameweek (for leaderboards)
model UserGameweekScore {
  id         String    @id @default(cuid())
  user       User      @relation(fields: [userId], references: [id])
  userId     String
  gameweek   Gameweek  @relation(fields: [gameweekId], references: [id])
  gameweekId String
  points     Int       @default(0)
  createdAt  DateTime  @default(now())

  @@unique([userId, gameweekId])
}

// Evolution log (for future UI + history)
model EvolutionEvent {
  id            String       @id @default(cuid())
  userMonster   UserMonster  @relation(fields: [userMonsterId], references: [id])
  userMonsterId String
  gameweek      Gameweek?    @relation(fields: [gameweekId], references: [id])
  gameweekId    String?
  reason        String
  oldLevel      Int
  newLevel      Int
  createdAt     DateTime     @default(now())
}

// Mini-leagues

model League {
  id          String         @id @default(cuid())
  name        String
  code        String         @unique
  owner       User           @relation("LeagueOwner", fields: [ownerId], references: [id])
  ownerId     String
  createdAt   DateTime       @default(now())
  memberships LeagueMember[]
}

model LeagueMember {
  id        String   @id @default(cuid())
  league    League   @relation(fields: [leagueId], references: [id])
  leagueId  String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())

  @@unique([leagueId, userId])
}

// Marketplace

model MarketListing {
  id            String       @id @default(cuid())
  seller        User         @relation(fields: [sellerId], references: [id])
  sellerId      String

  userMonster   UserMonster  @relation("UserMonsterListings", fields: [userMonsterId], references: [id])
  userMonsterId String

  price         Int
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())

  // NEW: listing expiry + resolution (for "items that didn't sell")
  expiresAt        DateTime?
  resolutionStatus String?   // "SOLD" | "EXPIRED_PENDING" | "EXPIRED_RETURNED" | "EXPIRED_QUICK_SOLD" | "EXPIRED_RELISTED"
  resolvedAt       DateTime?

  transactions  MarketTransaction[]

  // Only one active listing per monster at a time
  @@unique([userMonsterId, isActive])
}

model MarketTransaction {
  id            String          @id @default(cuid())
  listing       MarketListing?  @relation(fields: [listingId], references: [id])
  listingId     String?
  buyer         User            @relation("Buyer", fields: [buyerId], references: [id])
  buyerId       String
  seller        User            @relation("Seller", fields: [sellerId], references: [id])
  sellerId      String
  userMonster   UserMonster     @relation(fields: [userMonsterId], references: [id])
  userMonsterId String
  price         Int
  createdAt     DateTime        @default(now())
}

///////////////////////////////////////////////////////////
// NEW: Squad Builder Challenges (FUT-style SBC)
///////////////////////////////////////////////////////////

// Template of a challenge, like "Premier League Attack" etc.
model SquadChallengeTemplate {
  id          String                        @id @default(cuid())
  code        String                        @unique
  name        String
  description String
  // Optional constraints (kept simple as strings/ints)
  minMonsters     Int        @default(3)
  minRarity       String?    // e.g. "RARE" or above

  // NEW: exact rarity constraint, e.g. "COMMON" = only commons allowed
  requiredRarity  String?

  requiredPosition String?                  // e.g. "FWD", or null for any
  requiredClub     String?                  // e.g. "MCI", or null for any
  requiredNation   String?                  // reserved if you ever add nations later
  // Reward definition (coins / pack / special)
  rewardType  String                        // "coins" | "pack" | "special"
  rewardValue String
  isRepeatable Boolean                      @default(true)
  isActive    Boolean                       @default(true)
  createdAt   DateTime                      @default(now())

  submissions SquadChallengeSubmission[]
}

// A single user attempt/completion of a challenge
model SquadChallengeSubmission {
  id          String                           @id @default(cuid())
  user        User                             @relation(fields: [userId], references: [id])
  userId      String
  challenge   SquadChallengeTemplate           @relation(fields: [challengeId], references: [id])
  challengeId String
  createdAt   DateTime                         @default(now())
  completedAt DateTime?
  // Once completed, those monsters are "consumed" (we'll delete or flag them in code)
  monsters    SquadChallengeSubmissionMonster[]
  rewardGranted Boolean                        @default(false)
}

// Join table: which specific monsters were turned in for the submission
model SquadChallengeSubmissionMonster {
  id            String                   @id @default(cuid())
  submission    SquadChallengeSubmission @relation(fields: [submissionId], references: [id])
  submissionId  String
  userMonster   UserMonster              @relation(fields: [userMonsterId], references: [id])
  userMonsterId String
}

///////////////////////////////////////////////////////////
// NEW: Objectives system
///////////////////////////////////////////////////////////

// Template: defines an objective like "Open 3 packs", "Score 50 GW points"
model ObjectiveTemplate {
  id          String              @id @default(cuid())
  code        String              @unique
  name        String
  description String
  // e.g. "daily" | "weekly" | "season"
  period      String
  // Type: e.g. "open_packs", "score_points", "win_gameweeks"
  type        String

  // NEW: grouping & display
  category    String?
  seasonCode  String?
  sortOrder   Int                 @default(0)
  isRepeatable Boolean            @default(false)

  targetValue Int                 @default(1)
  // Reward: same convention as SBCs
  rewardType  String              // "coins" | "pack" | "special"
  rewardValue String
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())

  progresses  ObjectiveProgress[]
  sets        ObjectiveSetObjective[]
}

// Per-user progress towards a given objective
model ObjectiveProgress {
  id            String            @id @default(cuid())
  user          User              @relation(fields: [userId], references: [id])
  userId        String
  objective     ObjectiveTemplate @relation(fields: [objectiveId], references: [id])
  objectiveId   String
  currentValue  Int               @default(0)
  completedAt   DateTime?
  lastUpdatedAt DateTime          @default(now())

  // NEW: reward claimed (click-to-claim)
  rewardClaimedAt DateTime?

  @@unique([userId, objectiveId])
}

///////////////////////////////////////////////////////////
// NEW: Objective sets / paths
///////////////////////////////////////////////////////////

model ObjectiveSet {
  id            String                   @id @default(cuid())
  code          String                   @unique
  title         String
  description   String
  seasonCode    String?
  sortOrder     Int                      @default(0)
  rewardType    String                   // "coins" | "pack" | "special"
  rewardValue   String
  isActive      Boolean                  @default(true)
  createdAt     DateTime                 @default(now())

  objectives    ObjectiveSetObjective[]
  userProgresses UserObjectiveSetProgress[]
}

model ObjectiveSetObjective {
  id             String           @id @default(cuid())
  objectiveSet   ObjectiveSet     @relation(fields: [objectiveSetId], references: [id])
  objectiveSetId String
  objective      ObjectiveTemplate @relation(fields: [objectiveId], references: [id])
  objectiveId    String
}

model UserObjectiveSetProgress {
  id             String        @id @default(cuid())
  user           User          @relation(fields: [userId], references: [id])
  userId         String
  objectiveSet   ObjectiveSet  @relation(fields: [objectiveSetId], references: [id])
  objectiveSetId String
  isCompleted    Boolean       @default(false)
  completedAt    DateTime?
  createdAt      DateTime      @default(now())

  // NEW: set reward claimed (click-to-claim)
  rewardClaimedAt DateTime?

  @@unique([userId, objectiveSetId])
}

///////////////////////////////////////////////////////////
// NEW: Daily streak system
///////////////////////////////////////////////////////////

// Tracks daily login / daily claim streaks for a user
model DailyStreak {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String   @unique
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastClaimedAt DateTime?
  createdAt     DateTime @default(now())
}

///////////////////////////////////////////////////////////
// NEW: Monster history events
///////////////////////////////////////////////////////////

// Tracks actions applied to a specific UserMonster over time,
// e.g. who found it, who evolved it, who sold it, etc.
model MonsterHistoryEvent {
  id            String      @id @default(cuid())
  userMonster   UserMonster @relation(fields: [userMonsterId], references: [id])
  userMonsterId String

  // The user performing the action (finder, evolver, seller, buyer, etc.)
  actor         User        @relation("MonsterHistoryActor", fields: [actorUserId], references: [id])
  actorUserId   String

  // e.g. "CREATED", "EVOLVED", "SOLD", "BOUGHT"
  action        String
  description   String

  createdAt     DateTime    @default(now())
}

///////////////////////////////////////////////////////////
// NEW: Reward packs (earned from objectives / sets / SBC)
///////////////////////////////////////////////////////////

model RewardPack {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  packId     String   // "starter" | "bronze" | "silver" | "gold" etc.
  sourceType String   // "objective" | "objective_set" | "sbc" | "daily_streak" | etc.
  sourceRef  String?  // e.g. objective code or set code
  isOpened   Boolean  @default(false)
  createdAt  DateTime @default(now())
}

///////////////////////////////////////////////////////////
// NEW: Chips system for evolution
///////////////////////////////////////////////////////////

// Template for a chip, e.g. GOAL_SURGE, PLAYMAKER, WALL, etc.
model ChipTemplate {
  id            String      @id @default(cuid())
  code          String      @unique         // e.g. "GOAL_SURGE", "PLAYMAKER"
  name          String
  description   String
  // Condition type used in scoring logic:
  // "GOAL_SURGE" | "PLAYMAKER" | "WALL" | "HEROIC_HAUL" | "STEADY_FORM" | etc.
  conditionType String

  // Optional rarity / position constraints for UI & validation
  minRarity       String?
  maxRarity       String?
  allowedPositions String?                  // e.g. "FWD,MID"

  createdAt     DateTime    @default(now())

  userChips     UserChip[]
}

// A specific chip owned by a user (inventory item)
model UserChip {
  id          String       @id @default(cuid())
  user        User         @relation(fields: [userId], references: [id])
  userId      String
  template    ChipTemplate @relation(fields: [templateId], references: [id])
  templateId  String
  isConsumed  Boolean      @default(false)
  createdAt   DateTime     @default(now())

  assignments MonsterChipAssignment[]
}

// A chip "armed" on a specific monster for a specific gameweek
model MonsterChipAssignment {
  id            String        @id @default(cuid())
  userMonster   UserMonster   @relation(fields: [userMonsterId], references: [id])
  userMonsterId String

  userChip      UserChip      @relation(fields: [userChipId], references: [id])
  userChipId    String

  gameweek      Gameweek      @relation(fields: [gameweekId], references: [id])
  gameweekId    String

  createdAt     DateTime      @default(now())
}

///////////////////////////////////////////////////////////
// NEW: PvP Battle matchmaking
///////////////////////////////////////////////////////////

model BattleMatch {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  status    String   @default("WAITING") // WAITING | IN_PROGRESS | COMPLETED

  player1   User     @relation("BattleMatchPlayer1", fields: [player1Id], references: [id])
  player1Id String

  player2   User?    @relation("BattleMatchPlayer2", fields: [player2Id], references: [id])
  player2Id String?

  currentTurnPlayerId String?
  winnerUserId        String?

  // In the next step, we'll store the full battle snapshot here as JSON
  battleState Json?

  lastUpdatedAt DateTime @default(now())
}

model BattleQueueEntry {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  createdAt DateTime @default(now())
}
